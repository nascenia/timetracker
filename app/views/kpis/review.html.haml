- user_id   = params[:kpi].blank? ? '' : params[:kpi][:user_id]
- header    = "Submit team member KPI"
- header    = "Review and submit KPI of: #{@user.name}" unless user_id.blank?

%h2= header
%hr

= form_for(:kpi, url: review_kpis_path, method: :get, html: { class: '', 'data-controller' => 'kpireview' }) do |f|
  .row
    .col-md-4
      .form-group
        = f.label 'Team member'
        = label '', ' *', class: 'text-danger'
        = f.select :user_id, options_for_select(@team.map{ |u| [u.name, u.id] }, user_id), { include_blank: 'select' }, class: 'form-select'
    .col-md-2.form-group
      %br
      = f.submit 'Find KPI', class: 'btn btn-info btn-block'

- unless user_id.blank?
  - year          = params[:kpi][:start_date].blank? ? '' : params[:kpi][:start_date].split('-').first
  - time_period   = params[:kpi][:start_date].blank? ? '' : params[:kpi][:time_period]
  - start_date    = params[:kpi][:start_date].blank? ? '' : params[:kpi][:start_date]
  - end_date      = params[:kpi][:end_date].blank? ? '' : params[:kpi][:end_date]

  = form_for(:kpi, url: kpis_path, method: :post, html: { class: '', id: 'kpi-review-form' }) do |f|
    %hr
    .row
      .col-md-2
        .form-group
          - c_y = Time.now.year
          - s_y = c_y - 10
          = f.label 'Year'
          = label '', ' *', class: 'text-danger'
          = f.select :year, options_for_select((s_y..c_y).to_a.map{ |y| [y, y] }.reverse, year), { include_blank: 'select' }, class: 'form-select'
      .col-md-2
        .form-group
          = f.label 'Time period'
          = label '', ' *', class: 'text-danger'
          = f.select :time_period, options_for_select([['Q-1', '0'], ['Q-2', '1'], ['Q-3', '2'], ['Q-4', '3']], time_period), { include_blank: 'select'}, class: 'form-select'
      .col-md-2
        .form-group
          = f.label :start_date
          = label '', ' *', class: 'text-danger'
          = f.text_field :start_date, value: start_date, class: 'form-control', required: true
      .col-md-2
        .form-group
          = f.label :end_date
          = label '', ' *', class: 'text-danger'
          = f.text_field :end_date, value: end_date, class: 'form-control', required: true

    - @kpi_items.each do |kpi_item|
      %hr
      .row
        .col-md-10
          %label= kpi_item.title 
          %p= kpi_item.description
        .col-md-2
          %label Score
          = label '', ' *', class: 'text-danger'
          %br
          %input{ type: 'hidden', name: 'kpi_item_ids[]', value: kpi_item.id }
          %input{ type: 'text', name: 'kpi_item_score[]', value: '', class: 'form-control kpi-score', required: true }
          Out of 5
    %hr
    .row
      .col-md-12
        = f.label "TTF/ Appraiser's comment (about job/task/career):"
        = label '', ' *', class: 'text-danger'
        = f.text_area :ttf_comment, class: 'form-control', required: true

    = f.hidden_field :user_id, value: user_id
    %br
    = f.submit 'Save & submit', class: 'btn btn-success'
